<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>🏠 Nhà Thông Minh</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #89f7fe, #66a6ff);
      text-align: center;
      margin: 0;
      padding: 30px;
    }
    h1 {
      color: #333;
      margin-bottom: 10px;
    }
    .sensor {
      background: white;
      width: 320px;
      margin: 20px auto;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    .sensor h2 { margin: 8px 0; }
    .menu {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 15px;
      max-width: 600px;
      margin: 40px auto;
    }
    .card {
      background: white;
      border-radius: 15px;
      padding: 15px;
      text-decoration: none;
      color: #333;
      font-size: 18px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      transition: 0.2s;
    }
    .card:hover {
      background: #007bff;
      color: white;
      transform: scale(1.05);
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 10px;
      cursor: pointer;
      margin-top: 10px;
    }
    button:hover { background: #0056b3; }
    footer {
      margin-top: 40px;
      color: #444;
      font-size: 14px;
    }
    .good { color: green; }
    .warn { color: orange; }
    .bad  { color: red; }
    canvas {
      margin-top: 40px;
      max-width: 600px;
    }
  </style>
</head>
<body>
  <h1>🏠 Nhà Thông Minh</h1>
  <div class="sensor">
    <h2>🌡️ Nhiệt độ: <span id="temp">--</span>°C</h2>
    <h2>💧 Độ ẩm: <span id="hum">--</span>%</h2>
    <h2>🧯 Khí gas: <span id="gas">--</span></h2>
    <button id="connect">Kết nối Arduino</button>
  </div>

  <canvas id="chart" width="400" height="200"></canvas>

  <div class="menu">
    <a href="den.html" class="card">💡 Điều khiển đèn</a>
    <a href="quat.html" class="card">🌀 Điều khiển quạt</a>
    <a href="cua.html" class="card">🚪 Điều khiển cửa</a>
    <a href="info.html" class="card">ℹ️ Thông tin hệ thống</a>
  </div>

  <footer>
    ⚙️ Phiên bản 1.0 – Thiết kế bởi bạn 👨‍💻<br>
    © 2025 Smart Home Project
  </footer>

  <script>
    const connectBtn = document.getElementById("connect");
    const tempSpan = document.getElementById("temp");
    const humSpan = document.getElementById("hum");
    const gasSpan = document.getElementById("gas");
    let port, reader;

    const ctx = document.getElementById('chart').getContext('2d');
    const chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [
          {
            label: 'Nhiệt độ (°C)',
            data: [],
            borderColor: 'red',
            fill: false
          },
          {
            label: 'Độ ẩm (%)',
            data: [],
            borderColor: 'blue',
            fill: false
          }
        ]
      },
      options: {
        responsive: true,
        scales: {
          x: { display: true },
          y: { beginAtZero: true }
        }
      }
    });

    function updateDisplay(temp, hum, gas) {
      tempSpan.textContent = temp;
      humSpan.textContent = hum;

      tempSpan.className = temp > 35 ? "bad" : temp > 30 ? "warn" : "good";
      humSpan.className = hum < 30 ? "bad" : hum < 50 ? "warn" : "good";

      if (gas === "1") {
        gasSpan.textContent = "⚠️ Phát hiện khí gas!";
        gasSpan.className = "bad";
      } else {
        gasSpan.textContent = "✅ Bình thường";
        gasSpan.className = "good";
      }
    }

    function updateChart(temp, hum) {
      const now = new Date().toLocaleTimeString();
      chart.data.labels.push(now);
      chart.data.datasets[0].data.push(temp);
      chart.data.datasets[1].data.push(hum);
      chart.update();
    }

    connectBtn.addEventListener("click", async () => {
      try {
        port = await navigator.serial.requestPort();
        await port.open({ baudRate: 9600 });
        const decoder = new TextDecoderStream();
        port.readable.pipeTo(decoder.writable);
        reader = decoder.readable.getReader();

        connectBtn.textContent = "🔌 Đã kết nối";

        while (true) {
          const { value, done } = await reader.read();
          if (done) break;
          if (value) {
            const text = value.trim();
            const match = text.match(/T:(\d+\.?\d*)\s*H:(\d+\.?\d*)\s*G:(\d+)/);
            if (match) {
              const temp = parseFloat(match[1]);
              const hum = parseFloat(match[2]);
              const gas = match[3];
              updateDisplay(temp, hum, gas);
              updateChart(temp, hum);
            }
          }
        }
      } catch (err) {
        alert("Không thể kết nối Arduino: " + err);
      }
    });

    window.addEventListener("unload", async () => {
      if (reader) await reader.cancel();
      if (port) await port.close();
    });
  </script>
</body>
</html>
