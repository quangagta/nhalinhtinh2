<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Nh√† Th√¥ng Minh Web Serial</title>
    </head>
<body>
    <h1>üè† Nh√† Th√¥ng Minh</h1>
    
    <div style="border: 1px solid #ccc; padding: 20px; margin-bottom: 20px;">
        <p>üå°Ô∏è Nhi·ªát ƒë·ªô: <span id="tempValue">--¬∞C</span></p>
        <p>üíß ƒê·ªô ·∫©m: <span id="humiValue">--%</span></p>
    </div>

    <button onclick="connectSerial()" id="connectButton">K·∫øt n·ªëi Arduino</button>
    <br><br>

    <button onclick="sendCommand('DEN_TOGGLE')">üí° ƒêi·ªÅu khi·ªÉn ƒë√®n</button>
    <div id="systemInfoSection" style="margin-top: 30px; padding: 10px; background: #f0f0f0;">
        <h2>üìã Th√¥ng tin h·ªá th·ªëng</h2>
        <pre id="infoContent">ƒêang ch·ªù k·∫øt n·ªëi v√† nh·∫≠n d·ªØ li·ªáu...</pre>
        <p id="statusMessage" style="color: blue;"></p>
    </div>

    <script>
        // === CODE JAVASCRIPT B·∫ÆT ƒê·∫¶U ===
        let port; 
        let reader;
        let receivedData = ''; 
        const connectButton = document.getElementById('connectButton');
        const statusDisplay = document.getElementById('statusMessage');

        // 1. K·∫æT N·ªêI SERIAL
        async function connectSerial() {
            if (port) return; 

            try {
                // Y√™u c·∫ßu v√† m·ªü c·ªïng Serial
                port = await navigator.serial.requestPort();
                await port.open({ baudRate: 9600 });
                
                statusDisplay.textContent = "ƒê√£ k·∫øt n·ªëi th√†nh c√¥ng v·ªõi Arduino!";
                connectButton.textContent = "ƒê√£ K·∫øt N·ªëi";
                connectButton.disabled = true;

                readData(); // B·∫Øt ƒë·∫ßu ƒë·ªçc d·ªØ li·ªáu

            } catch (error) {
                console.error("L·ªói khi k·∫øt n·ªëi Serial:", error);
                statusDisplay.textContent = "L·ªói k·∫øt n·ªëi. Vui l√≤ng ki·ªÉm tra console.";
            }
        }

        // 2. G·ª¨I L·ªÜNH ƒêI·ªÄU KHI·ªÇN
        async function sendCommand(command) {
            if (!port || !port.writable) {
                alert("Ch∆∞a k·∫øt n·ªëi Serial!");
                return;
            }

            const writer = port.writable.getWriter();
            const encoder = new TextEncoder();
            
            await writer.write(encoder.encode(command + '\n'));
            writer.releaseLock();
            console.log(`ƒê√£ g·ª≠i l·ªánh: ${command}`);
        }

        // 3. ƒê·ªåC V√Ä PH√ÇN T√çCH D·ªÆ LI·ªÜU
        async function readData() {
            const textDecoder = new TextDecoderStream();
            port.readable.pipeTo(textDecoder.writable);
            reader = textDecoder.readable.getReader();

            while (true) {
                const { value, done } = await reader.read();
                if (done) {
                    reader.releaseLock();
                    break;
                }

                receivedData += value;
                const lines = receivedData.split('\n');
                receivedData = lines.pop(); // Gi·ªØ l·∫°i ph·∫ßn ch∆∞a ho√†n ch·ªânh

                lines.forEach(line => {
                    if (line.trim().length > 0) {
                        processLine(line.trim());
                    }
                });
            }
        }

        // 4. X·ª¨ L√ù D√íNG D·ªÆ LI·ªÜU ƒê·∫æN
        function processLine(dataLine) {
            const parts = dataLine.split(':');
            const key = parts[0]; 
            // L·∫•y ph·∫ßn c√≤n l·∫°i l√†m gi√° tr·ªã, v√¨ chu·ªói INFO c√≥ nhi·ªÅu d·∫•u hai ch·∫•m
            const value = parts.slice(1).join(':').trim(); 

            switch (key) {
                case "TEMP":
                    document.getElementById('tempValue').textContent = value + ' ¬∞C';
                    break;
                case "HUMI":
                    document.getElementById('humiValue').textContent = value + ' %';
                    break;
                case "INFO":
                    // Thay th·∫ø " | " b·∫±ng k√Ω t·ª± xu·ªëng d√≤ng "\n"
                    const formattedInfo = value.replace(/ \| /g, '\n'); 
                    document.getElementById('infoContent').textContent = formattedInfo;
                    break;
                case "STATUS":
                    // Hi·ªÉn th·ªã th√¥ng b√°o ph·∫£n h·ªìi
                    statusDisplay.textContent = `Arduino: ${value}`;
                    break;
                // Th√™m c√°c case kh√°c (CUA, QUAT) t·∫°i ƒë√¢y
            }
        }
        // === CODE JAVASCRIPT K·∫æT TH√öC ===
    </script>
</body>
</html>


